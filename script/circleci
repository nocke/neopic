#!/usr/bin/env node
// REF usage to skip clean:  npm run circleci -- nocheck

import { errLog, exec, log, warn } from './script-helpers.js'

try {

  const args = process.argv.slice(2)
  if (args.includes('nocheck')) {
    warn('skipping commit-check')
  } else {
    try {
      exec('git diff-index --quiet HEAD --')
      log('No uncommitted changes detected.')
    } catch (error) {
      errLog('Uncommitted changes! Please commit or stash them.')
      process.exit(1)
    }
  }

  const branch = 'master'
  const remoteRepo = exec(`git config branch.${branch}.remote`).trim()
  const tag = 'circleci-' + exec('git rev-parse --short=7 HEAD').toString().trim()

  exec(`git tag -f ${tag}`)
  exec(`git push ${remoteRepo} ${tag}`)

} catch (error) {
  console.error('failed to push changes:', error);
  process.exit(1);
}
